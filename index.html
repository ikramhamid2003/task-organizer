<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Task Management App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: "Warm Neutrals" -->
    <!-- Application Structure Plan: A single-page application that dynamically renders views based on a simulated user login. State is managed in a global object, and all data persists in IndexedDB. The UI is role-based, showing different dashboards and controls for Admin, Coordinator, and User roles. -->
    <!-- Visualization & Content Choices: The application uses interactive tables for data management (users, tasks), modals for creating/editing data to maintain context, and a simple dropdown for the simulated login. The core interaction is direct data manipulation through forms and buttons, with the UI reactively updating. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent the body itself from scrolling */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FDFBF8;
            color: #333;
        }
        .modal-overlay {
            transition: opacity 0.2s ease-in-out;
        }
        .modal-content {
            transition: transform 0.2s ease-in-out;
        }
        .toast {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            transform: translateY(100%);
            opacity: 0;
        }
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
            max-width: 250px;
            margin: auto;
        }
        .tab-button.active {
            border-bottom-color: #A37A57;
            color: #A37A57;
            font-weight: 600;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #A37A57;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased">

    <div id="app" class="h-screen w-screen flex flex-col">
        <!-- Main application content is rendered here -->
    </div>
    
    <!-- Toast Notification Container -->
    <div id="toast-container" class="fixed bottom-5 right-5 z-[60]"></div>

    <script>
        const App = {
            // STATE MANAGEMENT
            state: {
                db: null,
                users: [],
                tasks: [],
                roles: [],
                comments: [],
                notifications: [],
                currentUser: null,
                isInitialized: false,
                isLoading: false,
                activeModal: null,
                modalData: null,
                taskFilters: { status: 'all', userId: 'all', searchTerm: '', sortBy: 'createdAt' },
                taskStatusChart: null,
                activeTab: 'dashboard', // 'dashboard', 'profile', 'settings'
            },

            // ACTIONS
            setState(newState) {
                Object.assign(App.state, newState);
                App.render();
            },

            // DATA ACCESS LAYER
            dbService: {
                initDB() {
                    return new Promise((resolve, reject) => {
                        const request = indexedDB.open('TaskManagementDB', 4); // Version updated
                        request.onerror = e => reject('Database error: ' + e.target.errorCode);
                        request.onsuccess = e => resolve(e.target.result);
                        request.onupgradeneeded = (e) => {
                            const db = e.target.result;
                            const transaction = e.target.transaction;
                            let usersStore;

                            if (!db.objectStoreNames.contains('roles')) db.createObjectStore('roles', { keyPath: 'id' });
                            
                            if (!db.objectStoreNames.contains('users')) usersStore = db.createObjectStore('users', { keyPath: 'id', autoIncrement: true });
                            else usersStore = transaction.objectStore('users');
                            if (!usersStore.indexNames.contains('roleId')) usersStore.createIndex('roleId', 'roleId', { unique: false });
                            if (!usersStore.indexNames.contains('username')) usersStore.createIndex('username', 'username', { unique: true });

                            if (!db.objectStoreNames.contains('tasks')) {
                                const tasksStore = db.createObjectStore('tasks', { keyPath: 'id', autoIncrement: true });
                                tasksStore.createIndex('assignedTo', 'assignedTo', { unique: false });
                                tasksStore.createIndex('status', 'status', { unique: false });
                                tasksStore.createIndex('priority', 'priority', { unique: false });
                                tasksStore.createIndex('dueDate', 'dueDate', { unique: false });
                            }

                            if (!db.objectStoreNames.contains('comments')) {
                                const commentsStore = db.createObjectStore('comments', { keyPath: 'id', autoIncrement: true });
                                commentsStore.createIndex('taskId', 'taskId', { unique: false });
                            }
                            if (!db.objectStoreNames.contains('notifications')) {
                                const notificationsStore = db.createObjectStore('notifications', { keyPath: 'id', autoIncrement: true });
                                notificationsStore.createIndex('userId', 'userId', { unique: false });
                            }
                        };
                    });
                },
                exec(storeName, mode, operation) {
                    return new Promise((resolve, reject) => {
                        if (!App.state.db) return reject("Database not initialized.");
                        const tx = App.state.db.transaction(storeName, mode);
                        const store = tx.objectStore(storeName);
                        operation(store, resolve, reject);
                        tx.onerror = e => reject(e.target.error);
                    });
                },
                create(storeName, data) { return App.dbService.exec(storeName, 'readwrite', (s, res) => s.add(data).onsuccess = e => res(e.target.result)); },
                readAll(storeName) { return App.dbService.exec(storeName, 'readonly', (s, res) => s.getAll().onsuccess = e => res(e.target.result)); },
                update(storeName, data) { return App.dbService.exec(storeName, 'readwrite', (s, res) => s.put(data).onsuccess = e => res(e.target.result)); },
                remove(storeName, key) { return App.dbService.exec(storeName, 'readwrite', (s, res) => s.delete(key).onsuccess = () => res()); },
                clear(storeName) { return App.dbService.exec(storeName, 'readwrite', (s, res) => s.clear().onsuccess = () => res()); },
                findByIndex(storeName, indexName, query) {
                    return App.dbService.exec(storeName, 'readonly', (store, resolve) => {
                        store.index(indexName).getAll(query).onsuccess = e => resolve(e.target.result);
                    });
                },
            },

            // UTILITIES
            simpleHash(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = (hash << 5) - hash + char;
                    hash |= 0;
                }
                return hash.toString();
            },

            // APPLICATION LOGIC
            async init() {
                App.setState({ isLoading: true });
                try {
                    const db = await App.dbService.initDB();
                    App.state.db = db;

                    let roles = await App.dbService.readAll('roles');
                    if (roles.length === 0) {
                        await App.dbService.create('roles', { id: 1, name: 'Admin', permissions: ['user:manage', 'task:manage_all'] });
                        await App.dbService.create('roles', { id: 2, name: 'Coordinator', permissions: ['task:manage_all'] });
                        await App.dbService.create('roles', { id: 3, name: 'User', permissions: ['task:manage_own'] });
                        roles = await App.dbService.readAll('roles');
                    }
                    
                    let users = await App.dbService.readAll('users');
                     if (users.length === 0) {
                        await App.dbService.create('users', { name: 'Admin', roleId: 1, username: 'admin', password: App.simpleHash('password') });
                        await App.dbService.create('users', { name: 'Coordinator', roleId: 2, username: 'coordinator', password: App.simpleHash('password') });
                        await App.dbService.create('users', { name: 'Regular User', roleId: 3, username: 'user', password: App.simpleHash('password') });
                        users = await App.dbService.readAll('users');
                    }
                    
                    let tasks = await App.dbService.readAll('tasks');
                    if (tasks.length === 0) {
                        const now = new Date();
                        const tomorrow = new Date(now); tomorrow.setDate(now.getDate() + 1);
                        const yesterday = new Date(now); yesterday.setDate(now.getDate() - 1);
                        
                        await App.dbService.create('tasks', { title: 'Finalize Q3 budget report', description: 'Review all department submissions and compile the final report for the board meeting.', assignedTo: 2, createdBy: 1, status: 'In Progress', createdAt: now.toISOString(), priority: 'High', dueDate: tomorrow.toISOString().split('T')[0] });
                        await App.dbService.create('tasks', { title: 'Onboard new marketing hire', description: 'Prepare onboarding documents and schedule introductory meetings.', assignedTo: 2, createdBy: 1, status: 'Pending', createdAt: now.toISOString(), priority: 'Medium', dueDate: null });
                        await App.dbService.create('tasks', { title: 'Update website\'s privacy policy', description: 'Incorporate new GDPR guidelines and push to the live site.', assignedTo: 3, createdBy: 2, status: 'Pending', createdAt: now.toISOString(), priority: 'High', dueDate: yesterday.toISOString().split('T')[0] });
                        await App.dbService.create('tasks', { title: 'Test new login flow', description: 'Perform end-to-end testing on the staging environment for the new SSO feature.', assignedTo: 3, createdBy: 2, status: 'Completed', createdAt: now.toISOString(), priority: 'Low', dueDate: null });
                        await App.dbService.create('tasks', { title: 'Plan the annual company offsite', description: 'Gather quotes for venues and catering. Send out a survey for activity preferences.', assignedTo: 1, createdBy: 1, status: 'In Progress', createdAt: now.toISOString(), priority: 'Medium', dueDate: tomorrow.toISOString().split('T')[0] });
                        tasks = await App.dbService.readAll('tasks');
                    }
                    
                    App.setState({ roles, users, tasks, isInitialized: true, isLoading: false });
                    
                    const sessionUserId = sessionStorage.getItem('currentUserId');
                    if(sessionUserId) {
                        App.login(parseInt(sessionUserId));
                    }

                } catch (error) {
                    console.error("Initialization failed:", error);
                    document.getElementById('app').innerHTML = `<div class="text-red-500 p-8">Error initializing application. Please ensure IndexedDB is enabled in your browser.</div>`;
                    App.setState({ isLoading: false });
                }
            },

            promptForPassword(userId) {
                if (!userId) return;
                const user = App.state.users.find(u => u.id === userId);
                if (user) App.showModal('loginPassword', user);
            },

            authenticateUser(userId, username, password) {
                const user = App.state.users.find(u => u.id === userId);
                if (user && user.username === username && user.password === App.simpleHash(password)) {
                    App.closeModal();
                    App.login(userId);
                } else {
                    App.showToast('Invalid username or password.', 'error');
                }
            },
            
            async login(userId) {
                const user = App.state.users.find(u => u.id === userId);
                if (user) {
                    const role = App.state.roles.find(r => r.id === user.roleId);
                    const currentUser = { ...user, permissions: role.permissions };
                    sessionStorage.setItem('currentUserId', userId);
                    const notifications = await App.dbService.findByIndex('notifications', 'userId', userId);
                    App.setState({ currentUser, notifications });
                }
            },

            logout() {
                sessionStorage.removeItem('currentUserId');
                App.setState({ currentUser: null, taskFilters: { status: 'all', userId: 'all', searchTerm: '', sortBy: 'createdAt' }, activeTab: 'dashboard' });
            },

            showModal(modal, data = null) {
                App.setState({ activeModal: modal, modalData: data });
            },

            closeModal() {
                App.setState({ activeModal: null, modalData: null });
            },
            
            showToast(message, type = 'success') {
                const container = document.getElementById('toast-container');
                if (!container) return;
                const toast = document.createElement('div');
                const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
                toast.className = `toast text-white px-6 py-3 rounded-lg shadow-lg mb-2 ${bgColor}`;
                toast.textContent = message;
                container.appendChild(toast);
                setTimeout(() => toast.classList.add('show'), 10);
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            },
            
            // CRUD Actions
            async createUser(name, roleId, username, password) {
                if (!username || !password) return App.showToast('Username and password are required.', 'error');
                const newUser = { name, roleId: parseInt(roleId), username, password: App.simpleHash(password) };
                await App.dbService.create('users', newUser);
                const users = await App.dbService.readAll('users');
                App.closeModal();
                App.setState({ users });
                App.showToast('User created successfully.');
            },
            async updateUser(id, name, roleId, username, password) {
                const userToUpdate = await App.dbService.exec('users', 'readonly', (s, res) => s.get(id).onsuccess = e => res(e.target.result));
                const updatedUser = { ...userToUpdate, name, roleId: parseInt(roleId), username };
                if (password) updatedUser.password = App.simpleHash(password);
                await App.dbService.update('users', updatedUser);
                const users = await App.dbService.readAll('users');
                App.closeModal();
                App.setState({ users });
                App.showToast('User updated successfully.');
            },
            async deleteUser(id) {
                if (confirm('Are you sure you want to delete this user? This will also unassign their tasks.')) {
                    await App.dbService.remove('users', id);
                    const users = await App.dbService.readAll('users');
                    const tasksToUpdate = App.state.tasks.filter(t => t.assignedTo === id);
                    for (const task of tasksToUpdate) await App.dbService.update('tasks', {...task, assignedTo: null});
                    const tasks = await App.dbService.readAll('tasks');
                    App.setState({ users, tasks });
                    App.showToast('User deleted.');
                }
            },
            async createTask(title, description, assignedTo, priority, dueDate) {
                const assignedToId = parseInt(assignedTo) || null;
                const task = { title, description, assignedTo: assignedToId, createdBy: App.state.currentUser.id, status: 'Pending', createdAt: new Date().toISOString(), priority, dueDate };
                await App.dbService.create('tasks', task);
                if (assignedToId && assignedToId !== App.state.currentUser.id) {
                    await App.createNotification(assignedToId, `You have been assigned a new task: "${title}"`);
                }
                const tasks = await App.dbService.readAll('tasks');
                App.closeModal();
                App.setState({ tasks });
                App.showToast('Task created successfully.');
            },
            async updateTask(id, title, description, assignedTo, status, priority, dueDate) {
                 const originalTask = App.state.tasks.find(t => t.id === id);
                 const assignedToId = parseInt(assignedTo) || null;
                 const task = { ...originalTask, id, title, description, assignedTo: assignedToId, status, priority, dueDate };
                 await App.dbService.update('tasks', task);
                 if (assignedToId && assignedToId !== originalTask.assignedTo && assignedToId !== App.state.currentUser.id) {
                    await App.createNotification(assignedToId, `Task updated and assigned to you: "${title}"`);
                 }
                 const tasks = await App.dbService.readAll('tasks');
                 App.closeModal();
                 App.setState({ tasks });
                 App.showToast('Task updated successfully.');
            },
            async updateTaskStatus(id, status) {
                 const task = App.state.tasks.find(t => t.id === id);
                 if(task) {
                    await App.dbService.update('tasks', {...task, status});
                    const tasks = await App.dbService.readAll('tasks');
                    App.setState({ tasks });
                    App.showToast(`Task status updated to ${status}.`);
                 }
            },
            async deleteTask(id) {
                if (confirm('Are you sure you want to delete this task?')) {
                    await App.dbService.remove('tasks', id);
                    const tasks = await App.dbService.readAll('tasks');
                    App.setState({ tasks });
                    App.showToast('Task deleted.');
                }
            },
            async addComment(taskId, text) {
                if (!text.trim()) return;
                const comment = { taskId, userId: App.state.currentUser.id, text, createdAt: new Date().toISOString() };
                await App.dbService.create('comments', comment);
                const comments = await App.dbService.findByIndex('comments', 'taskId', taskId);
                App.setState({ comments }); // Re-render modal content
            },
            async createNotification(userId, text) {
                const notification = { userId, text, isRead: false, createdAt: new Date().toISOString() };
                await App.dbService.create('notifications', notification);
            },
            async markNotificationAsRead(id) {
                const notification = await App.dbService.exec('notifications', 'readonly', (s, res) => s.get(id).onsuccess = e => res(e.target.result));
                if (notification) {
                    await App.dbService.update('notifications', { ...notification, isRead: true });
                    const notifications = await App.dbService.findByIndex('notifications', 'userId', App.state.currentUser.id);
                    App.setState({ notifications });
                }
            },
            async changePassword(currentPassword, newPassword) {
                const { currentUser } = App.state;
                if (currentUser.password !== App.simpleHash(currentPassword)) {
                    return App.showToast('Current password is incorrect.', 'error');
                }
                if (!newPassword || newPassword.length < 6) {
                    return App.showToast('New password must be at least 6 characters.', 'error');
                }
                const updatedUser = { ...currentUser, password: App.simpleHash(newPassword) };
                await App.dbService.update('users', updatedUser);
                App.setState({ currentUser: updatedUser });
                App.showToast('Password changed successfully.');
            },
            
            // Data Portability
            exportData() {
                const dataToExport = {
                    version: "1.3",
                    exportDate: new Date().toISOString(),
                    data: { users: App.state.users, roles: App.state.roles, tasks: App.state.tasks, comments: App.state.comments, notifications: App.state.notifications }
                };
                const blob = new Blob([JSON.stringify(dataToExport, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `task-app-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                App.showToast('Data exported successfully.');
            },
            
            async importData(file) {
                if (!file || !confirm('This will replace all current data. Are you sure?')) return;
                App.setState({ isLoading: true });
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const imported = JSON.parse(e.target.result);
                        if (!imported.data || !imported.data.users || !imported.data.roles || !imported.data.tasks) throw new Error('Invalid backup file format.');
                        await Promise.all([App.dbService.clear('tasks'), App.dbService.clear('users'), App.dbService.clear('roles'), App.dbService.clear('comments'), App.dbService.clear('notifications')]);
                        for (const item of imported.data.roles) await App.dbService.create('roles', item);
                        for (const item of imported.data.users) await App.dbService.create('users', item);
                        for (const item of imported.data.tasks) await App.dbService.create('tasks', item);
                        if (imported.data.comments) for (const item of imported.data.comments) await App.dbService.create('comments', item);
                        if (imported.data.notifications) for (const item of imported.data.notifications) await App.dbService.create('notifications', item);
                        
                        const [roles, users, tasks, comments, notifications] = await Promise.all([App.dbService.readAll('roles'), App.dbService.readAll('users'), App.dbService.readAll('tasks'), App.dbService.readAll('comments'), App.dbService.readAll('notifications')]);
                        App.setState({ roles, users, tasks, comments, notifications, isLoading: false });
                        App.showToast('Data imported successfully!', 'success');
                    } catch (error) {
                        console.error("Import failed:", error);
                        App.showToast('Import failed. Check file format.', 'error');
                        App.setState({ isLoading: false });
                    }
                };
                reader.readAsText(file);
            },

            filterAndHighlight(status) {
                App.setState({ taskFilters: { ...App.state.taskFilters, status: status, userId: 'all' } });
                const taskSection = document.getElementById('task-management-section');
                if (taskSection) taskSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                setTimeout(() => {
                    const tableBody = document.querySelector('#task-management-section table tbody');
                    if (!tableBody) return;
                    const rows = tableBody.querySelectorAll('tr');
                    if (rows.length > 0 && !rows[0].textContent.includes('No tasks match')) {
                         rows.forEach(row => row.classList.add('bg-yellow-200', 'transition-colors', 'duration-500'));
                        setTimeout(() => rows.forEach(row => row.classList.remove('bg-yellow-200')), 3000);
                    }
                }, 500);
            },

            // RENDER LOGIC
            render() {
                const { isInitialized, currentUser, activeModal, isLoading } = App.state;
                const appContainer = document.getElementById('app');
                if (!appContainer) return;

                let finalHtml = '';
                if (isLoading) {
                    finalHtml = App.renderLoader();
                } else if (!isInitialized) {
                    finalHtml = `<div class="p-8">Initializing...</div>`;
                } else if (currentUser) {
                    finalHtml = App.renderDashboard();
                } else {
                    finalHtml = App.renderLogin();
                }

                if (activeModal) finalHtml += App.renderModal();
                appContainer.innerHTML = finalHtml;

                if (currentUser && currentUser.permissions.includes('task:manage_all')) App.renderTaskStatusChart();
                
                const statusFilter = document.getElementById('status-filter');
                if (statusFilter) statusFilter.value = App.state.taskFilters.status;
                const userFilter = document.getElementById('user-filter');
                if (userFilter) userFilter.value = App.state.taskFilters.userId;
                const searchInput = document.getElementById('search-input');
                if (searchInput) searchInput.value = App.state.taskFilters.searchTerm;
                const sortBySelect = document.getElementById('sort-by');
                if(sortBySelect) sortBySelect.value = App.state.taskFilters.sortBy;
            },

            renderLoader() {
                return `<div class="w-full h-full flex items-center justify-center"><div class="loader"></div></div>`;
            },
            
            renderLogin() {
                const { users } = App.state;
                return `
                    <div class="w-full h-full flex items-center justify-center bg-[#F5F2EF]">
                        <div class="w-full max-w-sm bg-white p-8 rounded-2xl shadow-lg border border-gray-200">
                            <h1 class="text-3xl font-bold text-center text-[#A37A57] mb-2">Welcome</h1>
                            <p class="text-center text-gray-500 mb-8">Please select your user profile to continue.</p>
                            <select id="user-select" class="w-full p-3 border border-gray-300 rounded-lg bg-white shadow-sm mb-6">
                                <option value="">Select a user...</option>
                                ${users.map(u => `<option value="${u.id}">${u.name}</option>`).join('')}
                            </select>
                            <button onclick="App.promptForPassword(parseInt(document.getElementById('user-select').value))" class="w-full bg-[#A37A57] text-white font-bold py-3 px-4 rounded-lg hover:bg-[#8e6a4d] transition-colors">
                                Next
                            </button>
                        </div>
                    </div>
                `;
            },
            
            renderDashboard() {
                const { currentUser, roles, activeTab, notifications } = App.state;
                const roleName = roles.find(r => r.id === currentUser.roleId)?.name || 'User';
                const unreadCount = notifications.filter(n => !n.isRead).length;
                
                let content = '';
                if (activeTab === 'profile') content = App.renderProfilePage();
                else if (activeTab === 'settings') content = App.renderSettingsPage();
                else if (currentUser.permissions.includes('user:manage')) content = App.renderAdminDashboard();
                else if (currentUser.permissions.includes('task:manage_all')) content = App.renderCoordinatorDashboard();
                else content = App.renderUserDashboard();

                return `
                    <header class="bg-white shadow-md p-4 flex justify-between items-center flex-shrink-0">
                        <h1 class="text-2xl font-bold text-[#A37A57]">Task Manager</h1>
                        <div class="flex items-center">
                            <div class="relative mr-4">
                                <button onclick="App.showModal('notifications')" class="text-gray-500 hover:text-gray-700">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>
                                </button>
                                ${unreadCount > 0 ? `<span class="absolute -top-2 -right-2 flex h-5 w-5 items-center justify-center rounded-full bg-red-500 text-xs font-bold text-white">${unreadCount}</span>` : ''}
                            </div>
                            <div class="text-right mr-4">
                                <p class="font-semibold">${currentUser.name}</p>
                                <p class="text-sm text-gray-500">${roleName}</p>
                            </div>
                            <button onclick="App.logout()" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">Logout</button>
                        </div>
                    </header>
                    <main class="flex-1 overflow-y-auto p-4 sm:p-6 md:p-8">
                        <div class="border-b border-gray-200 mb-6">
                            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                                <button onclick="App.setState({ activeTab: 'dashboard' })" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${activeTab === 'dashboard' ? 'active' : ''}">Dashboard</button>
                                <button onclick="App.setState({ activeTab: 'profile' })" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${activeTab === 'profile' ? 'active' : ''}">My Profile</button>
                                <button onclick="App.setState({ activeTab: 'settings' })" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${activeTab === 'settings' ? 'active' : ''}">Settings</button>
                            </nav>
                        </div>
                        ${content}
                    </main>
                `;
            },

            renderAdminDashboard() { return `${App.renderDashboardAnalytics()}${App.renderAdminDataPortability()}${App.renderUserManagementTable()}${App.renderTaskManagementTable()}`; },
            renderCoordinatorDashboard() { return `${App.renderDashboardAnalytics()}${App.renderTaskManagementTable()}`; },

            renderUserDashboard() {
                const { tasks, users, currentUser } = App.state;
                const myTasks = tasks.filter(t => t.assignedTo === currentUser.id);
                const creatorName = (id) => users.find(u => u.id === id)?.name || 'Unknown';
                
                return `
                    <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                        <h2 class="text-2xl font-bold mb-4 text-gray-800">My Assigned Tasks</h2>
                        ${myTasks.length === 0 ? `<div class="text-center py-12"><svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg><h3 class="mt-2 text-sm font-medium text-gray-900">No tasks assigned</h3><p class="mt-1 text-sm text-gray-500">You're all caught up!</p></div>` : ''}
                        <div class="space-y-4">
                            ${myTasks.map(task => `
                                <div class="border border-gray-200 p-4 rounded-lg">
                                    <div class="flex flex-col sm:flex-row justify-between sm:items-center">
                                        <div>
                                            <h3 class="text-lg font-semibold">${task.title}</h3>
                                            <p class="text-sm text-gray-600">${task.description}</p>
                                            <p class="text-xs text-gray-400 mt-1">Created by: ${creatorName(task.createdBy)} on ${new Date(task.createdAt).toLocaleDateString()}</p>
                                            <div class="flex items-center gap-4 mt-2">
                                                ${App.getPriorityBadge(task.priority)}
                                                ${task.dueDate ? App.getDueDateBadge(task.dueDate) : ''}
                                            </div>
                                        </div>
                                        <div class="mt-4 sm:mt-0 flex items-center space-x-4">
                                            ${App.getStatusBadge(task.status)}
                                            <select onchange="App.updateTaskStatus(${task.id}, this.value)" class="p-2 border border-gray-300 rounded-lg bg-white shadow-sm">
                                                <option value="Pending" ${task.status === 'Pending' ? 'selected' : ''}>Pending</option>
                                                <option value="In Progress" ${task.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                                                <option value="Completed" ${task.status === 'Completed' ? 'selected' : ''}>Completed</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            },

            renderProfilePage() {
                const { currentUser, roles, tasks } = App.state;
                const roleName = roles.find(r => r.id === currentUser.roleId)?.name || 'User';
                const assignedTasks = tasks.filter(t => t.assignedTo === currentUser.id);
                const completedTasks = assignedTasks.filter(t => t.status === 'Completed').length;

                return `
                    <div class="bg-white p-8 rounded-xl shadow-md border border-gray-200 max-w-2xl mx-auto">
                        <h2 class="text-3xl font-bold text-gray-800 mb-6">My Profile</h2>
                        <div class="space-y-4">
                            <div><span class="font-semibold text-gray-500">Name:</span> ${currentUser.name}</div>
                            <div><span class="font-semibold text-gray-500">Username:</span> ${currentUser.username}</div>
                            <div><span class="font-semibold text-gray-500">Role:</span> ${roleName}</div>
                        </div>
                        <hr class="my-6">
                        <h3 class="text-xl font-bold text-gray-700 mb-4">Task Summary</h3>
                        <div class="flex space-x-8">
                            <div><span class="text-2xl font-bold">${assignedTasks.length}</span><span class="ml-2 text-gray-500">Assigned Tasks</span></div>
                            <div><span class="text-2xl font-bold text-green-600">${completedTasks}</span><span class="ml-2 text-gray-500">Completed</span></div>
                        </div>
                    </div>
                `;
            },

            renderSettingsPage() {
                return `
                    <div class="bg-white p-8 rounded-xl shadow-md border border-gray-200 max-w-2xl mx-auto">
                        <h2 class="text-3xl font-bold text-gray-800 mb-6">Settings</h2>
                        <form onsubmit="event.preventDefault(); App.changePassword(this.currentPassword.value, this.newPassword.value)">
                            <div class="space-y-4">
                                <div><label class="block mb-1 font-semibold text-gray-600">Current Password</label><input name="currentPassword" type="password" required class="w-full p-2 border rounded"></div>
                                <div><label class="block mb-1 font-semibold text-gray-600">New Password</label><input name="newPassword" type="password" required class="w-full p-2 border rounded"></div>
                            </div>
                            <div class="flex justify-end mt-6">
                                <button type="submit" class="bg-[#A37A57] text-white font-bold py-2 px-4 rounded-lg">Change Password</button>
                            </div>
                        </form>
                    </div>
                `;
            },
            
            renderDashboardAnalytics() {
                const { tasks } = App.state;
                const total = tasks.length;
                const pending = tasks.filter(t => t.status === 'Pending').length;
                const inProgress = tasks.filter(t => t.status === 'In Progress').length;
                const completed = tasks.filter(t => t.status === 'Completed').length;

                return `
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Dashboard Overview</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
                            <div class="lg:col-span-3 grid grid-cols-2 sm:grid-cols-4 gap-6">
                                <div class="bg-white p-4 rounded-xl shadow-md border text-center"><p class="text-3xl font-bold">${total}</p><p class="text-gray-500">Total Tasks</p></div>
                                <div class="bg-white p-4 rounded-xl shadow-md border text-center cursor-pointer hover:shadow-lg hover:-translate-y-1 transition-all" onclick="App.filterAndHighlight('Pending')"><p class="text-3xl font-bold text-yellow-500">${pending}</p><p class="text-gray-500">Pending</p></div>
                                <div class="bg-white p-4 rounded-xl shadow-md border text-center cursor-pointer hover:shadow-lg hover:-translate-y-1 transition-all" onclick="App.filterAndHighlight('In Progress')"><p class="text-3xl font-bold text-blue-500">${inProgress}</p><p class="text-gray-500">In Progress</p></div>
                                <div class="bg-white p-4 rounded-xl shadow-md border text-center cursor-pointer hover:shadow-lg hover:-translate-y-1 transition-all" onclick="App.filterAndHighlight('Completed')"><p class="text-3xl font-bold text-green-500">${completed}</p><p class="text-gray-500">Completed</p></div>
                            </div>
                            <div class="lg:col-span-2 bg-white p-4 rounded-xl shadow-md border">
                                <div class="chart-container">
                                    <canvas id="taskStatusChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderTaskStatusChart() {
                const canvas = document.getElementById('taskStatusChart');
                if (!canvas) return;
                if (App.state.taskStatusChart) App.state.taskStatusChart.destroy();
                const { tasks } = App.state;
                const pending = tasks.filter(t => t.status === 'Pending').length;
                const inProgress = tasks.filter(t => t.status === 'In Progress').length;
                const completed = tasks.filter(t => t.status === 'Completed').length;
                const ctx = canvas.getContext('2d');
                App.state.taskStatusChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Pending', 'In Progress', 'Completed'],
                        datasets: [{ data: [pending, inProgress, completed], backgroundColor: ['#FBBF24', '#3B82F6', '#22C55E'], borderColor: '#FDFBF8', borderWidth: 4 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 20 } }, title: { display: true, text: 'Tasks by Status' } }, cutout: '60%' }
                });
            },

            renderAdminDataPortability() {
                return `
                    <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200 mb-8">
                        <h2 class="text-2xl font-bold mb-4 text-gray-800">Data Management</h2>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <button onclick="App.exportData()" class="flex-1 bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">Export All Data</button>
                            <div class="flex-1"><label class="block w-full text-center bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors cursor-pointer"><span>Import Data</span><input type="file" class="hidden" accept=".json" onchange="App.importData(this.files[0])"></label></div>
                        </div>
                    </div>
                `;
            },
            
            renderUserManagementTable() {
                const { users, roles } = App.state;
                const roleName = (id) => roles.find(r => r.id === id)?.name || 'Unknown';
                return `
                    <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200 mb-8">
                        <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-gray-800">User Management</h2><button onclick="App.showModal('createUser')" class="bg-[#A37A57] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#8e6a4d] transition-colors">Add User</button></div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead><tr class="border-b"><th class="p-2">Name</th><th class="p-2">Username</th><th class="p-2">Role</th><th class="p-2 text-right">Actions</th></tr></thead>
                                <tbody>
                                    ${users.map(user => `
                                        <tr class="border-b">
                                            <td class="p-2">${user.name}</td>
                                            <td class="p-2">${user.username}</td>
                                            <td class="p-2">${roleName(user.roleId)}</td>
                                            <td class="p-2 space-x-2 text-right">
                                                <button onclick='App.showModal("editUser", ${JSON.stringify(user)})' class="text-blue-500 hover:underline p-1">Edit</button>
                                                <button onclick="App.deleteUser(${user.id})" class="text-red-500 hover:underline p-1">Delete</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            },
            
            renderTaskManagementTable() {
                const { tasks, users, taskFilters } = App.state;
                const userName = (id) => users.find(u => u.id === id)?.name || 'Unassigned';
                const priorityOrder = { 'High': 1, 'Medium': 2, 'Low': 3 };
                let filteredTasks = tasks.filter(task => {
                    const statusMatch = taskFilters.status === 'all' || task.status === taskFilters.status;
                    const userMatch = taskFilters.userId === 'all' || task.assignedTo === parseInt(taskFilters.userId);
                    const searchMatch = !taskFilters.searchTerm || task.title.toLowerCase().includes(taskFilters.searchTerm.toLowerCase()) || task.description.toLowerCase().includes(taskFilters.searchTerm.toLowerCase());
                    return statusMatch && userMatch && searchMatch;
                });
                filteredTasks.sort((a, b) => {
                    if (taskFilters.sortBy === 'priority') return (priorityOrder[a.priority] || 4) - (priorityOrder[b.priority] || 4);
                    if (taskFilters.sortBy === 'dueDate') {
                        if (!a.dueDate) return 1; if (!b.dueDate) return -1;
                        return new Date(a.dueDate) - new Date(b.dueDate);
                    }
                    return new Date(b.createdAt) - new Date(a.createdAt);
                });

                return `
                    <div id="task-management-section" class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                        <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 gap-4">
                            <h2 class="text-2xl font-bold text-gray-800">Task Management</h2>
                            <div class="flex items-center gap-4 flex-wrap">
                                <input id="search-input" onkeyup="App.setState({ taskFilters: { ...App.state.taskFilters, searchTerm: this.value } })" type="text" placeholder="Search tasks..." class="p-2 border rounded w-full sm:w-auto">
                                <select id="sort-by" onchange="App.setState({ taskFilters: { ...App.state.taskFilters, sortBy: this.value } })" class="p-2 border rounded bg-white"><option value="createdAt">Sort by Newest</option><option value="priority">Sort by Priority</option><option value="dueDate">Sort by Due Date</option></select>
                                <select id="status-filter" onchange="App.setState({ taskFilters: { ...App.state.taskFilters, status: this.value } })" class="p-2 border rounded bg-white"><option value="all">All Statuses</option><option>Pending</option><option>In Progress</option><option>Completed</option></select>
                                <select id="user-filter" onchange="App.setState({ taskFilters: { ...App.state.taskFilters, userId: this.value } })" class="p-2 border rounded bg-white"><option value="all">All Users</option>${users.map(u => `<option value="${u.id}">${u.name}</option>`).join('')}</select>
                                <button onclick="App.showModal('createTask')" class="bg-[#A37A57] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#8e6a4d] transition-colors whitespace-nowrap">Add Task</button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead><tr class="border-b"><th class="p-2">Priority</th><th class="p-2">Title</th><th class="p-2">Assigned To</th><th class="p-2">Due Date</th><th class="p-2">Status</th><th class="p-2 text-right">Actions</th></tr></thead>
                                <tbody>
                                    ${filteredTasks.length > 0 ? filteredTasks.map(task => `
                                        <tr class="border-b">
                                            <td class="p-2">${App.getPriorityBadge(task.priority)}</td>
                                            <td class="p-2">${task.title}</td>
                                            <td class="p-2">${userName(task.assignedTo)}</td>
                                            <td class="p-2">${task.dueDate ? App.getDueDateBadge(task.dueDate) : 'N/A'}</td>
                                            <td class="p-2">${App.getStatusBadge(task.status)}</td>
                                            <td class="p-2 space-x-1 text-right">
                                                <button onclick='App.showModal("viewTask", ${JSON.stringify(task)})' title="View" class="text-gray-500 hover:text-gray-800 p-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.022 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg></button>
                                                <button onclick='App.showModal("editTask", ${JSON.stringify(task)})' title="Edit" class="text-blue-500 hover:text-blue-800 p-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>
                                                <button onclick="App.deleteTask(${task.id})" title="Delete" class="text-red-500 hover:text-red-800 p-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>
                                            </td>
                                        </tr>
                                    `).join('') : `<tr><td colspan="6" class="text-center p-8 text-gray-500"><div class="text-center py-12"><svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg><h3 class="mt-2 text-sm font-medium text-gray-900">No tasks found</h3><p class="mt-1 text-sm text-gray-500">Try adjusting your search or filter criteria.</p></div></td></tr>`}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            },
            
            getStatusBadge(status) {
                const c = 'px-2 py-1 text-xs font-semibold rounded-full';
                switch (status) {
                    case 'Pending': return `<span class="${c} bg-yellow-100 text-yellow-800">Pending</span>`;
                    case 'In Progress': return `<span class="${c} bg-blue-100 text-blue-800">In Progress</span>`;
                    case 'Completed': return `<span class="${c} bg-green-100 text-green-800">Completed</span>`;
                    default: return `<span class="${c} bg-gray-100 text-gray-800">${status}</span>`;
                }
            },
            getPriorityBadge(priority) {
                const c = 'w-6 h-6 flex items-center justify-center rounded-full text-white font-bold text-xs';
                switch (priority) {
                    case 'High': return `<span title="High Priority" class="${c} bg-red-500">H</span>`;
                    case 'Medium': return `<span title="Medium Priority" class="${c} bg-yellow-500">M</span>`;
                    case 'Low': return `<span title="Low Priority" class="${c} bg-green-500">L</span>`;
                    default: return '';
                }
            },
            getDueDateBadge(dueDate) {
                if (!dueDate) return '';
                const today = new Date(); today.setHours(0, 0, 0, 0);
                const due = new Date(dueDate);
                const isOverdue = due < today;
                return `<span class="text-xs ${isOverdue ? 'text-red-500 font-semibold' : 'text-gray-500'}">${new Date(dueDate).toLocaleDateString()} ${isOverdue ? '(Overdue)' : ''}</span>`;
            },
            
            renderModal() {
                const { activeModal, modalData, users, roles, comments } = App.state;
                let title = '', content = '', isEdit = !!modalData;

                switch(activeModal) {
                    case 'loginPassword':
                        title = `Login as ${modalData.name}`;
                        content = `<form onsubmit="event.preventDefault(); App.authenticateUser(${modalData.id}, this.username.value, this.password.value)"><div class="mb-4"><label class="block mb-1">Username</label><input name="username" type="text" required class="w-full p-2 border rounded" value="${modalData.username}"></div><div class="mb-6"><label class="block mb-1">Password</label><input name="password" type="password" required class="w-full p-2 border rounded"></div><div class="flex justify-end gap-4"><button type="button" onclick="App.closeModal()" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg">Cancel</button><button type="submit" class="bg-[#A37A57] text-white font-bold py-2 px-4 rounded-lg">Login</button></div></form>`;
                        break;
                    case 'createUser': case 'editUser':
                        title = isEdit ? 'Edit User' : 'Create User';
                        content = `<div class="max-h-[70vh] overflow-y-auto -mr-6 pr-6"><form onsubmit="event.preventDefault(); ${isEdit ? `App.updateUser(${modalData.id}, this.name.value, this.roleId.value, this.username.value, this.password.value)` : `App.createUser(this.name.value, this.roleId.value, this.username.value, this.password.value)`}"><div class="space-y-4"><div class="mb-4"><label class="block mb-1">Name</label><input name="name" type="text" required class="w-full p-2 border rounded" value="${modalData?.name || ''}"></div><div class="mb-4"><label class="block mb-1">Username</label><input name="username" type="text" required class="w-full p-2 border rounded" value="${modalData?.username || ''}"></div><div class="mb-4"><label class="block mb-1">Password</label><input name="password" type="password" ${!isEdit ? 'required' : ''} class="w-full p-2 border rounded" placeholder="${isEdit ? 'Leave blank to keep current' : ''}"></div><div class="mb-6"><label class="block mb-1">Role</label><select name="roleId" class="w-full p-2 border rounded bg-white" value="${modalData?.roleId || ''}">${roles.map(r => `<option value="${r.id}" ${modalData?.roleId === r.id ? 'selected' : ''}>${r.name}</option>`).join('')}</select></div></div><div class="flex justify-end gap-4 mt-6 border-t -mx-8 px-8 pt-4 sticky bottom-0 bg-white"><button type="button" onclick="App.closeModal()" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg">Cancel</button><button type="submit" class="bg-[#A37A57] text-white font-bold py-2 px-4 rounded-lg">${isEdit ? 'Save Changes' : 'Create User'}</button></div></form></div>`;
                        break;
                    case 'createTask': case 'editTask':
                        title = isEdit ? 'Edit Task' : 'Create Task';
                        content = `<div class="max-h-[70vh] overflow-y-auto -mr-6 pr-6"><form onsubmit="event.preventDefault(); ${isEdit ? `App.updateTask(${modalData.id}, this.title.value, this.description.value, this.assignedTo.value, this.status.value, this.priority.value, this.dueDate.value)` : `App.createTask(this.title.value, this.description.value, this.assignedTo.value, this.priority.value, this.dueDate.value)`}"><div class="space-y-4"><div><label class="block mb-1">Title</label><input name="title" type="text" required class="w-full p-2 border rounded" value="${modalData?.title || ''}"></div><div><label class="block mb-1">Description</label><textarea name="description" class="w-full p-2 border rounded">${modalData?.description || ''}</textarea></div><div class="grid grid-cols-2 gap-4"><div><label class="block mb-1">Assign To</label><select name="assignedTo" class="w-full p-2 border rounded bg-white" value="${modalData?.assignedTo || ''}"><option value="">Unassigned</option>${users.map(u => `<option value="${u.id}" ${modalData?.assignedTo === u.id ? 'selected' : ''}>${u.name}</option>`).join('')}</select></div><div><label class="block mb-1">Due Date</label><input name="dueDate" type="date" class="w-full p-2 border rounded" value="${modalData?.dueDate || ''}"></div></div><div><label class="block mb-1">Priority</label><select name="priority" class="w-full p-2 border rounded bg-white" value="${modalData?.priority || 'Medium'}"><option>Low</option><option>Medium</option><option>High</option></select></div>${isEdit ? `<div><label class="block mb-1">Status</label><select name="status" class="w-full p-2 border rounded bg-white" value="${modalData?.status || ''}"><option>Pending</option><option>In Progress</option><option>Completed</option></select></div>` : ''}</div><div class="flex justify-end gap-4 mt-6 border-t -mx-8 px-8 pt-4 sticky bottom-0 bg-white"><button type="button" onclick="App.closeModal()" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg">Cancel</button><button type="submit" class="bg-[#A37A57] text-white font-bold py-2 px-4 rounded-lg">${isEdit ? 'Save Changes' : 'Create Task'}</button></div></form></div>`;
                        break;
                    case 'viewTask':
                        const creator = users.find(u => u.id === modalData.createdBy)?.name || 'Unknown';
                        const assignee = users.find(u => u.id === modalData.assignedTo)?.name || 'Unassigned';
                        const taskComments = comments.filter(c => c.taskId === modalData.id).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                        title = 'Task Details';
                        content = `<div class="space-y-4 max-h-[70vh] overflow-y-auto pr-2"><div><h3 class="font-semibold text-gray-500 text-sm">Title</h3><p>${modalData.title}</p></div><div><h3 class="font-semibold text-gray-500 text-sm">Description</h3><p>${modalData.description || 'N/A'}</p></div><div class="grid grid-cols-2 gap-4"><div><h3 class="font-semibold text-gray-500 text-sm">Status</h3>${App.getStatusBadge(modalData.status)}</div><div><h3 class="font-semibold text-gray-500 text-sm">Priority</h3>${App.getPriorityBadge(modalData.priority)}</div><div><h3 class="font-semibold text-gray-500 text-sm">Assigned To</h3><p>${assignee}</p></div><div><h3 class="font-semibold text-gray-500 text-sm">Due Date</h3><p>${modalData.dueDate ? App.getDueDateBadge(modalData.dueDate) : 'N/A'}</p></div><div><h3 class="font-semibold text-gray-500 text-sm">Created By</h3><p>${creator}</p></div><div><h3 class="font-semibold text-gray-500 text-sm">Created On</h3><p>${new Date(modalData.createdAt).toLocaleString()}</p></div></div><hr class="my-4"><h3 class="font-semibold text-gray-600">Comments</h3><div class="space-y-3">${taskComments.length > 0 ? taskComments.map(c => `<div class="bg-gray-50 p-3 rounded-lg"><p class="text-sm">${c.text}</p><p class="text-xs text-gray-400 text-right mt-1">- ${users.find(u => u.id === c.userId)?.name || 'Unknown'} on ${new Date(c.createdAt).toLocaleDateString()}</p></div>`).join('') : '<p class="text-sm text-gray-500">No comments yet.</p>'}</div><form onsubmit="event.preventDefault(); App.addComment(${modalData.id}, this.commentText.value); this.commentText.value=''"><textarea name="commentText" placeholder="Add a comment..." required class="w-full p-2 border rounded mt-2"></textarea><div class="flex justify-end mt-2"><button type="submit" class="bg-blue-500 text-white font-bold py-1 px-3 rounded-lg">Post</button></div></form></div><div class="flex justify-end mt-6 border-t pt-4"><button type="button" onclick="App.closeModal()" class="bg-[#A37A57] text-white font-bold py-2 px-4 rounded-lg">Close</button></div>`;
                        break;
                    case 'notifications':
                        title = 'Notifications';
                        const userNotifications = App.state.notifications.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
                        content = `<div class="max-h-[60vh] overflow-y-auto space-y-2 pr-2">${userNotifications.length > 0 ? userNotifications.map(n => `<div onclick="App.markNotificationAsRead(${n.id})" class="p-3 rounded-lg cursor-pointer ${n.isRead ? 'bg-gray-50' : 'bg-blue-50 font-semibold'}"><p class="text-sm">${n.text}</p><p class="text-xs text-gray-400 mt-1">${new Date(n.createdAt).toLocaleString()}</p></div>`).join('') : '<p class="text-sm text-gray-500">No notifications.</p>'}</div><div class="flex justify-end mt-6 border-t pt-4"><button type="button" onclick="App.closeModal()" class="bg-[#A37A57] text-white font-bold py-2 px-4 rounded-lg">Close</button></div>`;
                        break;
                }
                if (!content) return '';
                return `<div class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="if(event.target === this) App.closeModal()"><div class="modal-content bg-white w-full max-w-lg p-8 rounded-2xl shadow-lg border border-gray-200 flex flex-col"><h2 class="text-2xl font-bold mb-6 flex-shrink-0">${title}</h2>${content}</div></div>`;
            }
        };

        document.addEventListener('DOMContentLoaded', App.init);
    </script>

</body>
</html>
